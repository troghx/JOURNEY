<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JSC - Personal Obrero</title>
  <link rel="icon" type="image/png" href="journey_no_bg.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
  />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      margin: 0;
      background-color: #03040c;
      color: #f9fafb;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 85% 15%, rgba(255, 212, 96, 0.55), rgba(255, 212, 96, 0) 55%),
        radial-gradient(circle at 12% 80%, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0) 60%);
      pointer-events: none;
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      inset: -10% -20%;
      background-image:
        radial-gradient(1.2px 1.2px at 20px 35px, rgba(255, 255, 255, 0.9) 45%, transparent 70%),
        radial-gradient(1.2px 1.2px at 80px 120px, rgba(255, 248, 209, 0.85) 45%, transparent 70%),
        radial-gradient(1.2px 1.2px at 140px 60px, rgba(255, 255, 255, 0.8) 45%, transparent 70%),
        radial-gradient(1.2px 1.2px at 30px 160px, rgba(255, 245, 199, 0.75) 45%, transparent 70%),
        radial-gradient(1.2px 1.2px at 160px 190px, rgba(255, 255, 255, 0.85) 45%, transparent 70%);
      background-size: 220px 220px, 240px 240px, 260px 260px, 280px 280px, 300px 300px;
      opacity: 0.75;
      pointer-events: none;
      z-index: -1;
      animation: star-drift 120s linear infinite, star-twinkle 6s ease-in-out infinite;
    }

    @keyframes star-drift {
      from {
        transform: translate3d(0, 0, 0) rotate(0deg);
        background-position: 0 0, 0 0, 0 0, 0 0, 0 0;
      }
      to {
        transform: translate3d(4%, -2%, 0) rotate(360deg);
        background-position: -320px 180px, -260px 140px, -220px 120px, -180px 100px, -140px 80px;
      }
    }

    @keyframes star-twinkle {
      0%,
      100% {
        opacity: 0.55;
      }
      50% {
        opacity: 0.95;
      }
    }

    .glass-panel {
      background: rgba(17, 24, 39, 0.72);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .radial-menu {
      position: fixed;
      top: 0;
      left: 0;
      transform: translate(-50%, -50%);
      width: 0;
      height: 0;
      opacity: 0.82;
      pointer-events: none;
      transition: opacity 0.18s ease;
      z-index: 50;
    }

    .radial-menu.active {
      opacity: 1;
      pointer-events: auto;
    }

    .radial-menu .menu-item {
      position: absolute;
      width: 3.2rem;
      height: 3.2rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(17, 24, 39, 0.78);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 14px 30px rgba(10, 17, 33, 0.32);
      color: #f9fafb;
      transform: translate(-50%, -50%) scale(0.5);
      opacity: 0.68;
      transition: transform 0.22s ease, opacity 0.22s ease, background 0.18s ease, border-color 0.18s ease;
      pointer-events: none;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .radial-menu.active .menu-item {
      opacity: 1;
      pointer-events: auto;
      background: rgba(17, 24, 39, 0.9);
    }

    .radial-menu .menu-item:hover {
      background: rgba(16, 185, 129, 0.92);
      border-color: rgba(16, 185, 129, 0.45);
      color: #022c22;
    }

    .menu-label {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translate(-50%, 0.4rem);
      font-size: 0.65rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: rgba(249, 250, 251, 0.72);
      pointer-events: none;
      white-space: nowrap;
      opacity: 0.82;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .radial-menu:not(.active) .menu-label {
      opacity: 0;
      transform: translate(-50%, 0.2rem) scale(0.9);
    }

    .radial-menu.active .menu-label {
      opacity: 0.9;
    }

    .radial-menu::after {
      content: '';
      position: absolute;
      width: 3rem;
      height: 3rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 9999px;
      background: radial-gradient(circle, rgba(16, 185, 129, 0.18) 0%, rgba(16, 185, 129, 0.04) 58%, rgba(16, 185, 129, 0) 72%);
      box-shadow: 0 0 70px 25px rgba(4, 120, 87, 0.22);
      opacity: 0.38;
      filter: blur(0.5px);
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.25s ease;
    }

    .radial-menu.active::after {
      opacity: 0.65;
      transform: translate(-50%, -50%) scale(1.05);
    }

    .search-panel {
      position: fixed;
      top: 8rem;
      right: clamp(1.5rem, 4vw, 3.75rem);
      width: min(90vw, 24rem);
      z-index: 40;
      opacity: 0;
      transform: translateY(1rem);
      transition: opacity 0.24s ease, transform 0.24s ease;
      pointer-events: none;
    }

    .search-panel.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .search-card {
      border-radius: 1.75rem;
      padding: 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .search-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .search-card-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      color: #f9fafb;
    }

    .close-search-button {
      appearance: none;
      border: none;
      border-radius: 9999px;
      background: rgba(255, 255, 255, 0.08);
      color: rgba(249, 250, 251, 0.78);
      width: 2.25rem;
      height: 2.25rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.18s ease, color 0.18s ease;
    }

    .close-search-button:hover {
      background: rgba(248, 250, 252, 0.18);
      color: #0f172a;
    }

    .search-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      text-align: left;
    }

    .search-input-label {
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(249, 250, 251, 0.56);
    }

    .search-input-field {
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-radius: 9999px;
      padding: 0.9rem 1.2rem;
      background: rgba(15, 23, 42, 0.78);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .search-input-field svg {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
      color: rgba(148, 163, 184, 0.8);
    }

    .search-input-field input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #f9fafb;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .search-input-field input::placeholder {
      color: rgba(148, 163, 184, 0.6);
    }

    .worker-results {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .worker-helper {
      margin: 0 auto;
      max-width: 22rem;
      text-align: center;
      font-size: 0.85rem;
      line-height: 1.5;
      color: rgba(226, 232, 240, 0.72);
    }

    .worker-helper--loading {
      color: rgba(125, 211, 252, 0.82);
    }

    .worker-helper--error {
      color: rgba(248, 113, 113, 0.82);
    }

    .worker-helper--empty {
      color: rgba(203, 213, 225, 0.72);
    }

    .worker-result-card {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.6rem;
      border-radius: 1.75rem;
      background: rgba(15, 23, 42, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.42);
      position: relative;
      overflow: hidden;
    }

    .worker-result-card[data-status='active'] {
      border-color: rgba(16, 185, 129, 0.32);
      box-shadow: 0 24px 50px rgba(16, 185, 129, 0.18);
    }

    .worker-result-card[data-status='inactive'] {
      border-color: rgba(248, 113, 113, 0.38);
      box-shadow: 0 24px 50px rgba(248, 113, 113, 0.2);
    }

    .worker-avatar {
      position: relative;
      display: inline-flex;
      padding: 0.45rem;
      border-radius: 1.75rem;
    }

    .worker-avatar::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      filter: blur(18px);
      opacity: 0.7;
      transition: opacity 200ms ease, transform 200ms ease;
      transform: scale(0.9);
      z-index: 0;
    }

    .worker-avatar[data-status='active']::before {
      background: radial-gradient(circle, rgba(16, 185, 129, 0.8), rgba(16, 185, 129, 0.08));
    }

    .worker-avatar[data-status='inactive']::before {
      background: radial-gradient(circle, rgba(248, 113, 113, 0.85), rgba(248, 113, 113, 0.1));
    }

    .worker-avatar[data-status='unknown']::before {
      background: radial-gradient(circle, rgba(59, 130, 246, 0.75), rgba(59, 130, 246, 0.08));
    }

    .worker-result-card:hover .worker-avatar::before {
      opacity: 0.95;
      transform: scale(1);
    }

    .worker-photo-placeholder {
      position: relative;
      width: 5.5rem;
      height: 5.5rem;
      border-radius: 1.5rem;
      background: linear-gradient(135deg, rgba(15, 118, 110, 0.32), rgba(14, 116, 144, 0.18));
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(4, 47, 46, 0.78);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      z-index: 1;
    }

    .worker-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      min-width: 0;
    }

    .worker-info h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 600;
      color: #f9fafb;
      text-align: left;
    }

    .worker-status-pill {
      align-self: flex-start;
      padding: 0.3rem 0.8rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 600;
      color: rgba(15, 23, 42, 0.92);
      background: rgba(255, 255, 255, 0.85);
    }

    .worker-status-pill[data-status='active'] {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.92), rgba(110, 231, 183, 0.88));
      color: rgba(2, 44, 34, 0.92);
    }

    .worker-status-pill[data-status='inactive'] {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.92), rgba(254, 202, 202, 0.9));
      color: rgba(76, 5, 25, 0.92);
    }

    .worker-status-pill[data-status='unknown'] {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.92), rgba(191, 219, 254, 0.9));
      color: rgba(17, 24, 39, 0.92);
    }

    .worker-meta {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 0.35rem;
      font-size: 0.85rem;
      color: rgba(226, 232, 240, 0.82);
    }

    .worker-meta-item {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      word-break: break-word;
    }

    .worker-meta-label {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.92);
    }

    @media (max-width: 640px) {
      .search-panel {
        top: auto;
        bottom: 1.5rem;
        left: 50%;
        right: auto;
        transform: translate(-50%, 1.5rem);
      }

      .search-panel.active {
        transform: translate(-50%, 0);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body class="relative flex flex-col items-center justify-start px-6 py-12 sm:py-16">
  <a
    href="seleccionar_personal.html"
    class="absolute left-6 top-6 inline-flex items-center text-sm font-medium text-white/70 transition hover:text-white"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
    Volver
  </a>

  <header class="glass-panel mt-24 w-full max-w-3xl rounded-3xl px-8 py-10 text-center">
    <p class="text-sm font-medium uppercase tracking-[0.3em] text-white/60">Personal Obrero</p>
    <h1 class="mt-4 text-3xl font-semibold text-white">
      Bienvenido <span id="welcome-name" class="text-emerald-200"></span>
    </h1>
    <p class="mt-2 text-lg text-white/80">¿Qué haremos hoy?</p>
  </header>

  <section class="mt-14 w-full max-w-4xl">
    <div class="glass-panel rounded-3xl px-8 py-10 text-center">
      <p class="text-base text-white/70">
        Explora las acciones disponibles con el menú radial. Haz clic derecho en cualquier parte de la pantalla para descubrir herramientas rápidas
        como búsqueda de personal, alta de colaboradores o la consulta de reportes generados.
      </p>
      <p class="mt-6 text-sm text-white/40">Tip: puedes cerrar el menú radial haciendo clic fuera de él o presionando la tecla Escape.</p>
    </div>
  </section>

  <div id="radial-menu" class="radial-menu" aria-hidden="true">
    <button type="button" class="menu-item" data-action="buscar-personal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <circle cx="11" cy="11" r="7" />
        <line x1="20" y1="20" x2="16.65" y2="16.65" />
      </svg>
      <span class="menu-label">Buscar personal</span>
    </button>
    <button type="button" class="menu-item" data-action="registrar-personal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M12 5a4 4 0 110 8 4 4 0 010-8z" />
        <path d="M20 21a8 8 0 10-16 0" />
        <line x1="19" y1="8" x2="19" y2="14" />
        <line x1="16" y1="11" x2="22" y2="11" />
      </svg>
      <span class="menu-label">Registrar personal</span>
    </button>
    <button type="button" class="menu-item" data-action="buscar-reportes">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
        <path d="M9 3h6a2 2 0 012 2v14l-5-3-5 3V5a2 2 0 012-2z" />
      </svg>
      <span class="menu-label">Reportes</span>
    </button>
  </div>

    <div id="search-panel" class="search-panel" aria-hidden="true">
    <div class="search-card glass-panel" role="dialog" aria-labelledby="search-panel-title">
      <div class="search-card-header">
        <h2 id="search-panel-title">Buscar trabajador</h2>
        <button type="button" class="close-search-button" id="close-search-panel" aria-label="Cerrar búsqueda">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
            <line x1="6" y1="6" x2="18" y2="18" />
            <line x1="18" y1="6" x2="6" y2="18" />
          </svg>
        </button>
      </div>
      <label class="search-input-wrapper" for="worker-search-input">
        <span class="search-input-label">Ingresa el nombre o ID</span>
        <div class="search-input-field">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
            <circle cx="11" cy="11" r="7" />
            <line x1="20" y1="20" x2="16.65" y2="16.65" />
          </svg>
          <input
            id="worker-search-input"
            type="text"
            placeholder="Escribe nombre, NSS o CURP"
            autocomplete="off"
          />
        </div>
      </label>
      <div id="worker-search-results" class="worker-results" aria-live="polite">
        <p class="worker-helper">Escribe el nombre del trabajador para iniciar la búsqueda.</p>
      </div>
    </div>
  </div>

  <script>
    const username = localStorage.getItem('jscUserName') || 'Equipo JSC';
    const nameTarget = document.getElementById('welcome-name');
    if (nameTarget) {
      nameTarget.textContent = username;
    }

    const radialMenu = document.getElementById('radial-menu');
    const menuItems = Array.from(radialMenu.querySelectorAll('.menu-item'));
    const searchPanel = document.getElementById('search-panel');
    const closeSearchPanelButton = document.getElementById('close-search-panel');
    const searchInput = document.getElementById('worker-search-input');
    const workerResultsContainer = document.getElementById('worker-search-results');

    const normalizeValue = (value) =>
      value
        ? value
            .toString()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase()
            .trim()
        : '';

    const cleanDisplayValue = (value) =>
      value ? value.toString().replace(/\*/g, '').replace(/\s+/g, ' ').trim() : 'Sin dato';

    const workerDatasetState = {
      data: [],
      promise: null,
      error: null,
    };

    const showHelperMessage = (text, modifier) => {
      if (!workerResultsContainer) return;
      const message = document.createElement('p');
      message.className = 'worker-helper';
      if (modifier) {
        message.classList.add(`worker-helper--${modifier}`);
      }
      message.textContent = text;
      workerResultsContainer.replaceChildren(message);
    };

    const getWorkerInitials = (name) => {
      if (!name) return 'OB';
      const sanitized = name.replace(/,/g, ' ');
      const parts = sanitized
        .split(/\s+/)
        .filter(Boolean)
        .slice(0, 3);
      if (parts.length === 0) return 'OB';
      const initials = parts
        .slice(0, 2)
        .map((part) => part[0] ?? '')
        .join('');
      return initials ? initials.toUpperCase() : parts[0][0].toUpperCase();
    };

    const createMetaItem = (label, value) => {
      const item = document.createElement('li');
      item.className = 'worker-meta-item';
      const labelElement = document.createElement('span');
      labelElement.className = 'worker-meta-label';
      labelElement.textContent = `${label}:`;
      const valueText = document.createElement('span');
      valueText.textContent = cleanDisplayValue(value) || 'Sin dato';
      item.append(labelElement, valueText);
      return item;
    };

    const createWorkerCard = (worker) => {
      const statusValue = normalizeValue(worker['Sigue en obra']);
      let statusKey = 'unknown';
      let statusLabel = 'Sin información';

      if (statusValue === 'si') {
        statusKey = 'active';
        statusLabel = 'Activo';
      } else if (statusValue === 'no') {
        statusKey = 'inactive';
        statusLabel = 'Baja';
      } else if (worker['Sigue en obra']) {
        statusLabel = cleanDisplayValue(worker['Sigue en obra']);
      }

      const card = document.createElement('article');
      card.className = 'worker-result-card';
      card.dataset.status = statusKey;

      const avatar = document.createElement('div');
      avatar.className = 'worker-avatar';
      avatar.dataset.status = statusKey;

      const photoPlaceholder = document.createElement('div');
      photoPlaceholder.className = 'worker-photo-placeholder';
      photoPlaceholder.textContent = getWorkerInitials(worker.Nombre);
      avatar.appendChild(photoPlaceholder);

      const info = document.createElement('div');
      info.className = 'worker-info';

      const nameHeading = document.createElement('h3');
      nameHeading.textContent = worker.Nombre || 'Sin nombre';
      info.appendChild(nameHeading);

      const statusPill = document.createElement('span');
      statusPill.className = 'worker-status-pill';
      statusPill.dataset.status = statusKey;
      statusPill.textContent = statusLabel;
      info.appendChild(statusPill);

      const metaList = document.createElement('ul');
      metaList.className = 'worker-meta';
      metaList.append(
        createMetaItem('NSS', worker.NSS),
        createMetaItem('CURP', worker.CURP),
        createMetaItem('Empresa', worker.Empresa_Edit || worker.Empresa)
      );
      info.appendChild(metaList);

      card.append(avatar, info);
      return card;
    };

    const ensureWorkerDataset = () => {
      if (workerDatasetState.data.length > 0) {
        return Promise.resolve(workerDatasetState.data);
      }

      if (workerDatasetState.promise) {
        return workerDatasetState.promise;
      }

      showHelperMessage('Cargando base de datos de personal...', 'loading');
      workerDatasetState.error = null;
      workerDatasetState.promise = fetch('data/personal_unicos.min.json')
        .then((response) => {
          if (!response.ok) {
            throw new Error(`No se pudo cargar el catálogo (estatus ${response.status})`);
          }
          return response.text();
        })
        .then((text) => {
          const sanitized = text.replace(/\bNaN\b/g, 'null');
          const parsed = JSON.parse(sanitized);
          const workers = parsed.filter(
            (person) => normalizeValue(person.Tipo) === 'obrero'
          );
          workers.sort((a, b) => (a.Nombre || '').localeCompare(b.Nombre || '', 'es', {
            sensitivity: 'base',
          }));
          workerDatasetState.data = workers.map((worker) => ({
            ...worker,
            _searchText: [
              worker.Nombre,
              worker.NSS,
              worker.CURP,
              worker.Empresa,
              worker.Empresa_Edit,
              worker.Cliente,
              worker.q,
            ]
              .filter(Boolean)
              .map((value) => normalizeValue(value))
              .join(' '),
          }));
          workerDatasetState.error = null;
          return workerDatasetState.data;
        })
        .catch((error) => {
          workerDatasetState.error = error;
          console.error('Error al cargar la base de datos de personal:', error);
          showHelperMessage('No se pudo cargar la base de datos. Intenta de nuevo.', 'error');
          throw error;
        })
        .finally(() => {
          workerDatasetState.promise = null;
        });

      return workerDatasetState.promise;
    };

    const updateSearchResults = (rawQuery) => {
      if (!workerResultsContainer) return;

      const trimmedQuery = rawQuery.trim();
      if (!trimmedQuery) {
        showHelperMessage('Escribe el nombre del trabajador para iniciar la búsqueda.');
        return;
      }

      const normalizedQuery = normalizeValue(trimmedQuery);
      if (!normalizedQuery) {
        showHelperMessage('Escribe el nombre del trabajador para iniciar la búsqueda.');
        return;
      }

      const matches = workerDatasetState.data
        .map((worker) => ({
          worker,
          score: worker._searchText.indexOf(normalizedQuery),
        }))
        .filter(({ score }) => score !== -1)
        .sort((a, b) => {
          if (a.score === b.score) {
            return (a.worker.Nombre || '').localeCompare(b.worker.Nombre || '', 'es', {
              sensitivity: 'base',
            });
          }
          return a.score - b.score;
        })
        .slice(0, 6)
        .map(({ worker }) => worker);

      if (matches.length === 0) {
        showHelperMessage('No encontramos coincidencias para tu búsqueda.', 'empty');
        return;
      }

      const fragment = document.createDocumentFragment();
      matches.forEach((worker) => {
        fragment.appendChild(createWorkerCard(worker));
      });
      workerResultsContainer.replaceChildren(fragment);
    };

    const pointer = {
      x: window.innerWidth / 2,
      y: window.innerHeight / 2,
    };

    let isMenuOpen = false;
    let frameHandle = null;
    const IDLE_RADIUS = 35;
    const ACTIVE_RADIUS = 88;
    const IDLE_SCALE = 0.55;
    const ACTIVE_SCALE = 1;
    const IDLE_OPACITY = 0.60;
    const ACTIVE_OPACITY = 1;

    const isSearchPanelOpen = () => searchPanel?.classList.contains('active');

    const applyMenuLayout = (radius, scale, opacity) => {
      const angleStep = (Math.PI * 2) / menuItems.length;
      menuItems.forEach((item, index) => {
        const angle = angleStep * index - Math.PI / 2;
        const x = radius * Math.cos(angle);
        const y = radius * Math.sin(angle);
        item.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${scale})`;
        item.style.opacity = opacity;
      });
    };

    const renderMenu = () => {
      frameHandle = null;
      radialMenu.style.left = `${pointer.x}px`;
      radialMenu.style.top = `${pointer.y}px`;
      const radius = isMenuOpen ? ACTIVE_RADIUS : IDLE_RADIUS;
      const scale = isMenuOpen ? ACTIVE_SCALE : IDLE_SCALE;
      const opacity = isMenuOpen ? ACTIVE_OPACITY : IDLE_OPACITY;
      applyMenuLayout(radius, scale, opacity);
    };

    const scheduleRender = () => {
      if (frameHandle !== null) return;
      frameHandle = requestAnimationFrame(renderMenu);
    };

    const setMenuState = (open) => {
      if (open === isMenuOpen) {
        scheduleRender();
        return;
      }

      isMenuOpen = open;
      radialMenu.classList.toggle('active', isMenuOpen);
      radialMenu.setAttribute('aria-hidden', isMenuOpen ? 'false' : 'true');
      scheduleRender();
    };

    const closeRadialMenu = () => {
      if (!isMenuOpen) return;
      setMenuState(false);
    };


    const openSearchPanel = () => {
      if (!searchPanel) return;
      searchPanel.classList.add('active');
      searchPanel.setAttribute('aria-hidden', 'false');
      scheduleRender();
      if (!searchInput?.value.trim()) {
        showHelperMessage('Escribe el nombre del trabajador para iniciar la búsqueda.');
      }
      ensureWorkerDataset().catch(() => {});
      if (searchInput) {
        setTimeout(() => {
          searchInput.focus({ preventScroll: true });
        }, 160);
      }
    };

    const closeSearchPanel = () => {
      if (!searchPanel || !isSearchPanelOpen()) return;
      searchPanel.classList.remove('active');
      searchPanel.setAttribute('aria-hidden', 'true');
      if (searchInput) {
        searchInput.blur();
      }
    };

    document.addEventListener('mousemove', (event) => {
      pointer.x = event.clientX;
      pointer.y = event.clientY;
      if (!isMenuOpen) {
        scheduleRender();
      }
    });

    document.addEventListener('contextmenu', (event) => {
      event.preventDefault();
      pointer.x = event.clientX;
      pointer.y = event.clientY;
      setMenuState(true);
    });

    document.addEventListener('click', (event) => {
      if (isMenuOpen && !radialMenu.contains(event.target)) {
        closeRadialMenu();
      }
  
      if (isSearchPanelOpen() && !searchPanel.contains(event.target)) {
        closeSearchPanel();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        if (isMenuOpen) {
          closeRadialMenu();
        }
        closeSearchPanel();
      }
    });

    window.addEventListener('blur', () => {
      closeRadialMenu();
      closeSearchPanel();
    });

    window.addEventListener('resize', () => {
      closeRadialMenu();
      scheduleRender();
    });

    closeSearchPanelButton?.addEventListener('click', (event) => {
      event.preventDefault();
      closeSearchPanel();
    });

    if (searchInput) {
      searchInput.addEventListener('input', (event) => {
        const query = event.target.value;
        if (workerDatasetState.data.length > 0) {
          updateSearchResults(query);
        } else if (!query.trim()) {
          showHelperMessage('Escribe el nombre del trabajador para iniciar la búsqueda.');
        }

        ensureWorkerDataset()
          .then(() => {
            updateSearchResults(query);
          })
          .catch(() => {});
      });

      searchInput.addEventListener('focus', () => {
        ensureWorkerDataset().catch(() => {});
      });
    }

    menuItems.forEach((item) => {
      item.addEventListener('click', (event) => {
        event.stopPropagation();
        const action = item.dataset.action;
        closeRadialMenu();

        if (action === 'buscar-personal') {
          openSearchPanel();
          return;
        }
    
        if (action === 'registrar-personal') {
          window.location.href = 'registro_obrero.html';
          return;
        }

        if (!action) return;

        const label = item.querySelector('.menu-label')?.textContent ?? action;
        const messageBanner = document.createElement('div');
        messageBanner.textContent = `Opción "${label}" seleccionada.`;
        messageBanner.className = 'fixed bottom-8 left-1/2 z-40 -translate-x-1/2 rounded-full bg-emerald-500/90 px-5 py-2 text-sm font-medium text-emerald-950 shadow-lg shadow-emerald-500/40 transition duration-300';
        document.body.appendChild(messageBanner);
        setTimeout(() => {
          messageBanner.classList.add('opacity-0', 'translate-y-3');
        }, 1800);
        setTimeout(() => messageBanner.remove(), 2100);
      });
    });

    scheduleRender();
  </script>
</body>
</html>
